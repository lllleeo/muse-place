/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
*/

import * as THREE from "three";
import React, { useMemo, useRef } from "react";
import { useGLTF } from "@react-three/drei";

import { GLTF } from "three/examples/jsm/loaders/GLTFLoader";
import { DRACO_URL, useTrimeshCollision } from "spacesvr";
import { BufferGeometry } from "three";
import { useLoader } from "react-three-fiber";
import { MeshStandardMaterial } from "three";

type GLTFResult = GLTF & {
  nodes: {
    barbers: THREE.Mesh;
    highlight: THREE.Mesh;
    customs: THREE.Mesh;
    barberpole: THREE.Mesh;
    barbershop_glass: THREE.Mesh;
    trash: THREE.Mesh;
    lattice: THREE.Mesh;
    windows: THREE.Mesh;
    windows_glass: THREE.Mesh;
    building: THREE.Mesh;
    sidewalk: THREE.Mesh;
    street: THREE.Mesh;
    collider: THREE.Mesh;
  };
  materials: {
    ["barbers.mat"]: THREE.MeshStandardMaterial;
    ["highlight.mat"]: THREE.MeshStandardMaterial;
    ["customs.mat"]: THREE.MeshStandardMaterial;
    ["barberpole.mat"]: THREE.MeshStandardMaterial;
    ["barbershop_glass.mat"]: THREE.MeshStandardMaterial;
    ["trash.mat"]: THREE.MeshStandardMaterial;
    ["lattice.mat"]: THREE.MeshStandardMaterial;
    ["windows.mat"]: THREE.MeshStandardMaterial;
  };
};

const FILE_URL =
  "https://d27rt3a60hh1lx.cloudfront.net/models/C2ASidewalk-1613902888/sidewalk_03.glb";

const TILE_TEX =
  "https://d27rt3a60hh1lx.cloudfront.net/content/c2a/white_tile.jpg";
const CONCRETE_TEX =
  "https://d27rt3a60hh1lx.cloudfront.net/content/c2a/concrete2.jpg";
const STREET_TEX =
  "https://d27rt3a60hh1lx.cloudfront.net/content/c2a/concrete1.jpg";

export default function Model(props: JSX.IntrinsicElements["group"]) {
  const group = useRef<THREE.Group>();
  const { nodes, materials } = useGLTF(FILE_URL, DRACO_URL) as GLTFResult;

  useTrimeshCollision(
    (nodes.collider.geometry as BufferGeometry).clone().scale(0.35, 0.35, 0.35)
  );

  // whtie tile texture
  const tileTex = useLoader(THREE.TextureLoader, TILE_TEX);
  tileTex.repeat.x = tileTex.repeat.y = 16;
  tileTex.wrapS = tileTex.wrapT = THREE.RepeatWrapping;
  const tileMat = useMemo(() => new MeshStandardMaterial({ map: tileTex }), [
    tileTex,
  ]);

  // sidewalk texture
  const concreteTex = useLoader(THREE.TextureLoader, CONCRETE_TEX);
  concreteTex.repeat.x = concreteTex.repeat.y = 90;
  concreteTex.wrapS = concreteTex.wrapT = THREE.RepeatWrapping;
  const concreteMat = useMemo(
    () => new MeshStandardMaterial({ map: concreteTex }),
    [concreteTex]
  );

  // sidewalk texture
  const streetTex = useLoader(THREE.TextureLoader, STREET_TEX);
  streetTex.repeat.x = streetTex.repeat.y = 40;
  streetTex.wrapS = streetTex.wrapT = THREE.RepeatWrapping;
  const streetMat = useMemo(
    () => new MeshStandardMaterial({ map: streetTex }),
    [streetTex]
  );

  return (
    <group ref={group} {...props} dispose={null}>
      <group scale={[0.35, 0.35, 0.35]}>
        <mesh
          name="barber"
          material={materials["barbers.mat"]}
          geometry={nodes.barbers.geometry}
        />
        <mesh
          name="highlight"
          material={materials["highlight.mat"]}
          geometry={nodes.highlight.geometry}
        />
        <mesh
          name="customs"
          material={materials["customs.mat"]}
          geometry={nodes.customs.geometry}
        />
        <mesh
          name="barberpole"
          material={materials["barberpole.mat"]}
          geometry={nodes.barberpole.geometry}
        />
        <mesh
          name="barbershop_glass"
          material={materials["barbershop_glass.mat"]}
          geometry={nodes.barbershop_glass.geometry}
        />
        <mesh
          name="trash"
          material={materials["trash.mat"]}
          geometry={nodes.trash.geometry}
        />
        <mesh
          name="lattice"
          material={materials["lattice.mat"]}
          geometry={nodes.lattice.geometry}
          scale={[0.8432, -0.8432, 0.8432]}
        />
        <mesh
          name="windows"
          material={materials["windows.mat"]}
          geometry={nodes.windows.geometry}
          scale={[0.8432, -0.8432, 0.8432]}
        />
        <mesh
          name="windows_glass"
          material={nodes.windows_glass.material}
          geometry={nodes.windows_glass.geometry}
        />
        <mesh
          name="building"
          material={tileMat}
          geometry={nodes.building.geometry}
        />
        <mesh
          name="street"
          material={streetMat}
          geometry={nodes.street.geometry}
          scale={[2.0335, 2.0335, 2.0335]}
        />
        <mesh
          name="sidewalk"
          material={concreteMat}
          geometry={nodes.sidewalk.geometry}
        />
      </group>
    </group>
  );
}

useGLTF.preload(FILE_URL, DRACO_URL);
